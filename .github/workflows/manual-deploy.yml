name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Target to deploy'
        required: true
        default: 'backend'
        type: choice
        options:
        - backend
      force_deploy:
        description: 'Force deploy even if tests fail'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  manual-deploy:
    name: Manual Deploy via Render Webhook
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Debug workflow context
      run: |
        echo "🔍 Debug information:"
        echo "Event name: ${{ github.event_name }}"
        echo "Event inputs: ${{ toJson(github.event.inputs) }}"
        echo "Deploy target: ${{ github.event.inputs.deploy_target }}"
        echo "Force deploy: ${{ github.event.inputs.force_deploy }}"
        
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy Backend via Webhook
      run: |
        echo "🚀 Deploying Backend via Render Webhook..."
        echo "Target: ${{ github.event.inputs.deploy_target }}"
        echo "Force: ${{ github.event.inputs.force_deploy }}"
        
        # Deploy backend using Render webhook
        curl -X POST "https://api.render.com/deploy/srv-d30dm795pdvs73ftb5kg?key=ja_Cdk7jxKQ" \
          -H "Content-Type: application/json" \
          -d '{
            "clearCache": "do_not_clear"
          }'
        
        echo "✅ Backend deploy triggered successfully!"
        
    - name: Wait for deployment
      run: |
        echo "⏳ Waiting for deployment to complete..."
        sleep 15
        echo "✅ Deployment should be processing..."
        
    - name: Manual Deploy Summary
      if: always()
      run: |
        echo "## Manual Deploy Summary" >> $GITHUB_STEP_SUMMARY
        echo "### Deploy Target" >> $GITHUB_STEP_SUMMARY
        echo "- Target: ${{ github.event.inputs.deploy_target }}" >> $GITHUB_STEP_SUMMARY
        echo "- Force Deploy: ${{ github.event.inputs.force_deploy }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Webhook Used" >> $GITHUB_STEP_SUMMARY
        echo "- Backend: https://api.render.com/deploy/srv-d30dm795pdvs73ftb5kg?key=ja_Cdk7jxKQ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "### Status: ✅ Manual deployment successful!" >> $GITHUB_STEP_SUMMARY
          echo "- Check Render dashboard for deployment status" >> $GITHUB_STEP_SUMMARY
        else
          echo "### Status: ❌ Manual deployment failed!" >> $GITHUB_STEP_SUMMARY
        fi